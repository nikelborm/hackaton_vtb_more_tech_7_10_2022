version: '3.9'
services:
  nginx-prod:
    image: "nikelborm/home:${PROJECT_NAME}-nginx-prod"
    ports:
      - "${PROD_EXTERNAL_NGINX_HTTP_PORT}:${PROD_INNER_NGINX_HTTP_PORT}/tcp"
      - "${PROD_EXTERNAL_NGINX_HTTPS_PORT}:${PROD_INNER_NGINX_HTTPS_PORT}/tcp"
    restart: always
    depends_on:
      - backend-prod
    build:
      context: ./frontend/
      target: static
      args:
        - PROD_EXTERNAL_NGINX_HTTP_PORT=${PROD_EXTERNAL_NGINX_HTTP_PORT}
        - PROD_EXTERNAL_NGINX_HTTPS_PORT=${PROD_EXTERNAL_NGINX_HTTPS_PORT}
    environment:
      - TZ=${TZ}
      - GENERATE_SOURCEMAP=${GENERATE_SOURCEMAP}
      - PROD_INNER_NGINX_HTTP_PORT=${PROD_INNER_NGINX_HTTP_PORT}
      - PROD_INNER_NGINX_HTTPS_PORT=${PROD_INNER_NGINX_HTTPS_PORT}
      - PROD_INNER_BACKEND_HTTP_SERVER_PORT=${PROD_INNER_BACKEND_HTTP_SERVER_PORT}
      - PROD_INNER_BACKEND_WS_SERVER_PORT=${PROD_INNER_BACKEND_WS_SERVER_PORT}
    networks:
      - nginx-back-net
    # volumes:
    #   - ./data/certbot/conf:/etc/letsencrypt
    #   - ./data/certbot/www:/var/www/certbot
  # certbot:
  #   image: certbot/certbot
  #   command: certonly -n -d local.host --webroot --agree-tos --email kolya007.klass@gmail.com -w /var/www/certbot
  #   volumes:
  #     - ./data/certbot/conf:/etc/letsencrypt
  #     - ./data/certbot/www:/var/www/certbot
  #     - ./data/certbot/logs:/var/log/letsencrypt/
  backend-prod:
    image: "nikelborm/home:${PROJECT_NAME}-backend-prod"
    networks:
      - nginx-back-net
      - back-db-net
    restart: always
    depends_on:
      - postgres-prod
    environment:
      - TZ=${TZ}
      - PROJECT_ENV_TYPE=${PROJECT_ENV_TYPE}
      - SERVER_PORT=${PROD_INNER_BACKEND_HTTP_SERVER_PORT}
      - WEB_SOCKET_SERVER_PORT=${PROD_INNER_BACKEND_WS_SERVER_PORT}
      - BOOTSTRAP_MODE=${BOOTSTRAP_MODE}
      - MOCK_SCRIPT_NAME=${MOCK_SCRIPT_NAME}
      - JWT_SECRET=${JWT_SECRET}
      - USER_PASSWORD_HASH_SALT=${USER_PASSWORD_HASH_SALT}
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_USERNAME=${DATABASE_USERNAME}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_TYPEORM_LOGGING_MODE=${DATABASE_TYPEORM_LOGGING_MODE}
    build:
      context: ./backend/
      target: production
  postgres-prod:
    image: postgres
    restart: always
    networks:
      - back-db-net
    command: "-c default_text_search_config=pg_catalog.russian"
    environment:
      - TZ=${TZ}
      - POSTGRES_PASSWORD=${DATABASE_PASSWORD}
      - POSTGRES_USER=${DATABASE_USERNAME}
      - POSTGRES_DB=${DATABASE_NAME}
    volumes:
      - type: volume
        source: postgres-prod-data
        target: /var/lib/postgresql/data

volumes:
  postgres-prod-data:

# when i will really want to use https and ssl
# article how to setup certbot and let's encrypt
# https://pentacent.medium.com/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71
# online nginx configuration
# https://www.digitalocean.com/community/tools/nginx
# TODO: research posibility to use serial device and run smarthouse
# https://www.losant.com/blog/how-to-access-serial-devices-in-docker

networks:
  nginx-back-net: {}
  back-db-net: {}
